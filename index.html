<!DOCTYPE html>
<html>
  <head>
    <title>CleanCab App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="styleph.css">
  </head>
  <body onload="init()">

<!-- Simulate a smartphone / tablet -->
<div class="mobile-containerx">

<!-- Top Navigation Menu -->
<div class="topnav">
  <a href="#home" class="active">CleanCab</a>
  <div id="idleLinks">
    <a href="javascript:connect()">Connect</a>
    <a href="javascript:showDiv('contactDiv')">Contact</a>
  </div>
  
  <div id="connectedLinks">
    <a href="javascript:disconnect()">Disconnect</a>
    <a href="javascript:showDiv('statusDiv')">Status</a>
    <a href="javascript:showDiv('commissionDiv')">Commission</a>
    <a href="javascript:showDiv('settingDiv')">Settings</a>
    <!--a href="javascript:showAlarmLog()">Pressure Alarm</a -->
    <a href="javascript:showDiv('filterDetailsDiv')">Filter Details</a>
    <!--a href="javascript:showDiv('filterHistory')">Filter History</a-->
    <a href="javascript:showDiv('contactDiv')">Contact</a>
  </div>
  <a href="javascript:void(0);" class="icon" onclick="toggleMenu()">
    <i style="display:inline-block;font:normal normal normal 14px/1 FontAwesome;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale">
    &#9776;   
    </i>
  </a>
</div>

<div id="connectingDiv" style="padding-left:16px; display:block;">
  <h3>Connection</h3>
  <div class="container">
    <div class="row">
      <div style="width: 100%;height: 150px;background-image: url('cleancab.png'); background-repeat: no-repeat; background-size: contain; background-position: center;">
      </div>
    </div>
    <div class="row">
      <p id="connectingState"></p>  
      <p id="phdbg"></p>
    </div>
  </div>
</div>

<div id="filterHistory" style="padding-left:16px; display:none;">
  <h3>Filter History</h3>
  <div class="container">
    <div class="row grid-border">
      <div class="col-15">
      <label>Date Installed</label>
      </div>
      <div class="col-15">
      <label>Filter</label>
      </div>
      <div class="col-25">
      <label>Part Number</label>
      </div>      
      <div class="col-45">
      <label>Installed By</label>
      </div>      
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr1c1">01/12/2024</label>
      </div>
      <div class="col-15">
      <label id="flr1c2">HEPA</label>
      </div>
      <div class="col-25">
      <label id="flr1c3">04623787112</label>
      </div>      
      <div class="col-45">
      <label id="flr1c4">Peter Holmes, 01213</label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr2c1"></label>
      </div>
      <div class="col-15">
      <label id="flr2c2"></label>
      </div>
      <div class="col-25">
      <label id="flr2c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr2c4"></label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr3c1"></label>
      </div>
      <div class="col-15">
      <label id="flr3c2"></label>
      </div>
      <div class="col-25">
      <label id="flr3c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr3c4"></label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr4c1"></label>
      </div>
      <div class="col-15">
      <label id="flr4c2"></label>
      </div>
      <div class="col-25">
      <label id="flr4c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr4c4"></label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr5c1"></label>
      </div>
      <div class="col-15">
      <label id="flr5c2"></label>
      </div>
      <div class="col-25">
      <label id="flr5c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr5c4"></label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr6c1"></label>
      </div>
      <div class="col-15">
      <label id="flr6c2"></label>
      </div>
      <div class="col-25">
      <label id="flr6c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr6c4"></label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr7c1"></label>
      </div>
      <div class="col-15">
      <label id="flr7c2"></label>
      </div>
      <div class="col-25">
      <label id="flr7c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr7c4"></label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr8c1"></label>
      </div>
      <div class="col-15">
      <label id="flr8c2"></label>
      </div>
      <div class="col-25">
      <label id="flr8c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr8c4"></label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr9c1"></label>
      </div>
      <div class="col-15">
      <label id="flr9c2"></label>
      </div>
      <div class="col-25">
      <label id="flr9c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr9c4"></label>
      </div> 
    </div>
    <div class="row grid-border">
      <div class="col-15">
      <label id="flr10c1"></label>
      </div>
      <div class="col-15">
      <label id="flr10c2"></label>
      </div>
      <div class="col-25">
      <label id="flr10c3"></label>
      </div>      
      <div class="col-45">
      <label id="flr10c4"></label>
      </div> 
    </div>
  </div>
</div>

<div id="statusDiv" style="padding-left:16px; display:none;">
  <h3>Status</h3>
  <div class="container">
    <form>
    <div class="row">
      <div class="col-25">
        <label>Fan</label>
      </div>
      <div class="col-65">
        <div class="row-progress">
          <div id="sFanSpeedBar" class="container-progress" style="width:10%">10%</div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-25">
        <label>Pressure</label>
      </div>
      <div class="col-65">
        <div class="row-progress">
          <div id="sPressureBar" class="container-progress" style="width:10%">10pa</div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-25">
        <label>Door</label>
      </div>
      <div class="col-65">
        <input type="text" id="sDoorState" readonly value="Disabledx">
      </div>
    </div>
    <div class="row">
      <div class="col-25">
        <label>Alarm</label>
      </div>
      <div class="col-65">
        <input type="text" id="sAlarmState" readonly value="Disabledx">
      </div>
    </div>
    <div class="row">
      <div class="col-25">
        <label>CO2</label>
      </div>
      <div class="col-65">
        <input type="text" id="sCO2State" readonly value="Disabledx">
      </div>
    </div>
    </form>
  </div>
  <h3>Running Times</h3>
  <div class="container">
    <form>
    <div class="row">
      <div class="col-25">
        <label>Motor</label>
      </div>
      <div class="col-65">
        <input type="text" id="sMotorTime" name="sMotorTime" readonly value="123">
      </div>
      <div class="col-5">
        <label class="units">mins</label>
      </div>
    </div>
    <div class="row">
      <div class="col-25">
        <label>HEPA</label>
      </div>
      <div class="col-65">
        <input type="text" id="sHepaFilterTime" name="sHepaFilterTime" readonly value="123">
      </div>
      <div class="col-5">
        <label class="units">mins</label>
      </div>
    </div>
    <div class="row">
      <div class="col-25">
        <label>Main Filter</label>
      </div>
      <div class="col-65">
        <input type="text" id="sMainFilterTime" name="sMainFilterTime" readonly value="123">
      </div>
      <div class="col-5">
        <label class="units">mins</label>
      </div>
    </div>    
    </form>
  </div>
</div>

<div id="filterDetailsDiv" style="padding-left:16px; display:none;">
  <h3>Replace Filters</h3>
  <div class="container">
    <form>
      <div class="row" id="addHepaDiv">
        <div class="col-35">
          <label>Hepa Filter</label>
        </div>          
        <div class="col-65">
            <input id="addHepaBtn" type="button" value="Replace" onclick="replaceFilter(1)" class="btn">
        </div>
      </div>
      <div class="row" id="addMainDiv">
        <div class="col-35">
          <label>Main Filter</label>
        </div>          
        <div class="col-65">
          <input id="addMainBtn" type="button" value="Replace" onclick="replaceFilter(2)" class="btn">
        </div>
      </div>
      <div id="filterForm" style="display:none;">
        <div class="row">
          <div class="col-35">
            <label>Part Number</label>
          </div>
          <div class="col-65">
            <input type="text" id="filterPartNumber" value="">
          </div>
        </div>
        <div class="row">
          <div class="col-35">
            <label>Installer Name</label>
          </div>
          <div class="col-65">
            <input type="text" id="filterInstallerName" value="">
          </div>
        </div>
        <div class="row">
          <div class="col-35">
            <label>Installer Id</label>
          </div>
          <div class="col-65">
            <input type="text" id="filterInstallerId" value="">
          </div>
        </div>
        <div class="row">
          <div class="col-35">
          </div>
          <div class="col-65">
            <input id="filterSaveBtn" type="button" value="Save" onclick="filterSave()" class="btn">
          </div>
        </div>
      </div>
    </form>
  </div>
  <h3>HEPA Filter Details</h3>
  <div class="container">
    <form id="hepaFilterForm">
    <div class="row">
      <div class="col-35">
        <label>Installed Date</label>
      </div>
      <div class="col-65">
        <input type="date" id="hepaInstalledDate" readonly value="2024-02-18">
      </div>
    </div>
    <div class="row">
      <div class="col-35">
        <label>Part Number</label>
      </div>
      <div class="col-65">
        <input type="text" id="hepaPartNumber" readonly value="">
      </div>
    </div>
    <div class="row">
      <div class="col-35">
        <label>Installer Name</label>
      </div>
      <div class="col-65">
        <input type="text" id="hepaInstallerName" readonly value="">
      </div>
    </div>
    <div class="row">
      <div class="col-35">
        <label>Installer Id</label>
      </div>
      <div class="col-65">
        <input type="text" id="hepaInstallerId" readonly value="">
      </div>
    </div>
    </form>
  </div>
  <h3>Main Filter Details</h3>
  <div class="container">
    <form id="mainFilterForm">
      <div class="row">
        <div class="col-35">
          <label>Installed Date</label>
        </div>
        <div class="col-65">
          <input type="date" id="mainInstalledDate" readonly value="2024-02-18">
        </div>
      </div>
      <div class="row">
        <div class="col-35">
          <label>Part Number</label>
        </div>
        <div class="col-65">
          <input type="text" id="mainPartNumber" readonly value="">
        </div>
      </div>
      <div class="row">
        <div class="col-35">
          <label>Installer Name</label>
        </div>
        <div class="col-65">
          <input type="text" id="mainInstallerName" readonly value="">
        </div>
      </div>
      <div class="row">
        <div class="col-35">
          <label>Installer Id</label>
        </div>
        <div class="col-65">
          <input type="text" id="mainInstallerId" readonly value="">
        </div>
      </div>
    </form>
  </div>  
</div>

<div id="commissionDiv" style="padding-left:16px; display:none;">
  <h3>Commission</h3>
  <div class="container">
    <p id="phdbg1"></p>
    <form id="commissionForm">
      <div class="row">
        <div class="col-25">
          <label>Installed Date</label>
        </div>
        <div class="col-75">
          <input type="date" id="cInstalledDate" name="cInstalledDate" readonly value="2024-02-18">
        </div>
      </div>
      <div class="row">
        <div class="col-25">
          <label>Company</label>
        </div>
        <div class="col-75">
          <input type="text" id="cInstallerCompany" name="cInstallerCompany" readonly value="">
        </div>
      </div>
      <div class="row">
        <div class="col-25">
          <label>Installed By</label>
        </div>
        <div class="col-75">
          <input type="text" id="cInstallerName" name="cInstallerName" readonly value="">
        </div>
      </div>
      <div class="row">
        <div class="col-25">
          <label>Contact</label>  
        </div>
        <div class="col-75">
          <input type="text" id="cInstallerPhone" name="cInstallerPhone" readonly value="">
        </div>
      </div>
      <div class="row">
        <div class="col-25">
          <label>Machine Name</label>
        </div>
        <div class="col-75">
          <input type="text" id="cMachineName" name="cMachineName" readonly value="">
        </div>
      </div>
      <div class="row">
        <div class="col-25">
          <label>Plant Number</label>
        </div>
        <div class="col-75">
          <input type="text" id="cPlantNumber" name="cPlantNumber" readonly value="">
        </div>
      </div>
      <div class="row" id="cSaveRow" style="display:none;">
        <input type="submit" value="Save" class="btn">
      </div>
    </form>
    <div class="row">
      <div class="col-25">
        <label>Check for leaks</label>
      </div>
      <div class="col-75">
        <label class="switch">
          <input type="checkbox">
          <span class="slider round"></span>
        </label>
      </div>
    </div>
  </div>
</div>

<div id="contactDiv" style="padding-left:16px; display:none;">   
  <h3>Contact</h3>
  <div class="container">
    <div class="row">
      <div style="width: 100%;height: 150px;background-image: url('cleancab.png'); background-repeat: no-repeat; background-size: contain; background-position: center;">
      </div>
    </div>
    <div class="row">
      <p>Address :<a href="">3 Rose Smith Lane, Muckadilla QLD 4461</a></p>
    </div>
    <div class="row">
      <p>Phone :<a href="tel:+427477740">0427 477 740</a></p>
    </div>
    <div class="row">
      <p>Email :<a href="mailto:info@cleancab.au">info@cleancab.au</a></p>
    </div>
    <div class="row">
      <p>Facebook :<a href="https://www.facebook.com/profile.php?id=61550062888002">CLEANCAB filtration system</a></p>
    </div>    
  </div>
</div>

<div id="settingDiv" style="padding-left:16px; display:none;">             
  <h3>Settings</h3>
  <div class="container">
    <form id="settingForm">
      <div class="row">
        <div class="col-40">
          <label>Operating Mode</label>
        </div>
        <div class="col-5">
        </div>
        <div class="col-50">
          <input type="radio" name="fmode" value="0" checked onclick="handleModeClick(this);"><label>Fixed</label><br>
          <input type="radio" name="fmode" value="1" onclick="handleModeClick(this);"><label>Adaptive</label>
        </div>
        <div class="col-5">
            <label></label>
        </div>
      </div>
      <div class="row">  
        <div class="col-40">
          <label>Ramp Rate</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">How fast the blower changes speed. Default is 20ms</span></div>
        </div>
        <div class="col-50">
          <input type="number" id="frampRate" name="frampRate" min="1" max="200" placeholder="20">
        </div>
        <div class="col-5">
          <label class="units">ms</label>
        </div>
      </div>
      <div class="row" id="settingStartPause">  
        <div class="col-40">
          <label>Startup Pause Time</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">The time to hold the fan at max speed after power on</span></div>
        </div>
        <div class="col-50">
          <input type="number" id="fstartPause" name="fstartPause" min="0" max="300" placeholder="30">
        </div>
        <div class="col-5">
          <label class="units">sec</label>
        </div>
      </div>                   
      <div class="row">  
        <div class="col-40">
          <label>Door Opened Fan Speed</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">The fan speed when the door is opened</span></div>
        </div>
        <div class="col-50">
          <input type="number" id="fdoorSpeed" name="fdoorSpeed" min="0" max="100" placeholder="20">
        </div>
        <div class="col-5">
          <label class="units">%</label>
        </div>
      </div>
      <div class="row">  
        <div class="col-40">
          <label>Fixed Fan Speed</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">The required fan speed</span></div>
        </div>
        <div class="col-50">
          <input type="number" id="ffixedSpeed" name="ffixedSpeed" min="0" max="100" placeholder="70">
        </div>
        <div class="col-5">
          <label class="units">%</label>
        </div>
      </div>
      <div class="row">  
        <div class="col-40">
          <label>Target Pressure</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">The target pressure for the cabin (pa)</span></div>
        </div>
        <div class="col-50">
          <input type="number" id="ftargetPressure" name="ftargetPressure" min="10" max="200" placeholder="30" disabled>
        </div>
        <div class="col-5">
          <label class="units">pa</label>
        </div>
      </div>      
      <div class="row">  
        <div class="col-40">
          <label>Step Size</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">The fan speed change amount to obtain the target pressure</span></div>
        </div>
        <div class="col-50">
          <input type="number" id="fstepSize" name="fstepSize" min="1" max="100" placeholder="10" disabled>
        </div>
        <div class="col-5">
          <label class="units">%</label>
        </div>
      </div>      
      <div class="row">  
        <div class="col-40">
          <label>Hold Time</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">The rate at which the fan speed is updated to obtain the target pressure</span></div>
        </div>
        <div class="col-50">
          <input type="number" id="fholdTime" name="fholdTime" min="0" max="300" placeholder="30" disabled>
        </div>
        <div class="col-5">
          <label class="units">sec</label>
        </div>
      </div>             
      <div class="row">  
        <div class="col-40">
          <label>Min Fan Speed</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">The minimum fan speed</span></div>
        </div>
        <div class="col-50">
          <input type="number" id="fminSpeed" name="fminSpeed" min="0" max="100" placeholder="10" disabled>
        </div>
        <div class="col-5">
          <label class="units">%</label>
        </div>
      </div>
      <div class="row" id="settingDoorMode">  
        <div class="col-40">
          <label>Door Detect Mode</label>
        </div>
        <div class="col-5">
          <div class="tooltip">?<span class="tooltiptext">How the door switch detector works</span></div>
        </div>
        <div class="col-50">
          <input type="radio" name="fdoorMode" value="0" checked><label>Disabled</label><br>
          <input type="radio" name="fdoorMode" value="1"><label>N/O</label><br>
          <input type="radio" name="fdoorMode" value="1"><label>N/C</label>
        </div>
      </div>             
      <div class="row" id="settingAlarmMode">  
        <div class="col-40">
          <label>Alarm Detect Mode</label>
        </div>
        <div class="col-5">
        </div>
        <div class="col-50">
          <input type="radio" name="falarmMode" value="0" checked><label>Disabled</label><br>
          <input type="radio" name="falarmMode" value="1"><label>N/O</label><br>
          <input type="radio" name="falarmMode" value="1"><label>N/C</label>
        </div>
      </div>  
      <div class="row" id="settingCO2Mode">  
        <div class="col-40">
          <label>CO2 Detect Mode</label>
        </div>
        <div class="col-5">
        </div>
        <div class="col-50">
          <input type="radio" name="fco2Mode" value="0" checked><label>Disabled</label><br>
          <input type="radio" name="fco2Mode" value="1"><label>N/O</label><br>
          <input type="radio" name="fco2Mode" value="1"><label>N/C</label>
        </div>
      </div> 
      <div class="row">
        <input id="settingSaveBtn" type="submit" value="Save Settings" class="btn">
      </div>
    </form> 
  </div>
</div>
<!-- End smartphone / tablet look -->
</div>

<script>

//const phdbg = document.querySelector("#phdbg");

const phdbg = document.querySelector("#phdbg");
var phdbgc = 0;

const settingForm = document.querySelector("#settingForm");
const commissionForm = document.querySelector("#commissionForm");
const hepaFilterForm = document.querySelector("#hepaFilterForm");
const mainFilterForm = document.querySelector("#mainFilterForm");
//const settingSaveBtn = document.querySelector("#settingSaveBtn");

// Settings fields
const fieldRampRate = document.querySelector("#frampRate");
const fieldStartPause = document.querySelector("#fstartPause");
const fieldDoorSpeed = document.querySelector("#fdoorSpeed");
const fieldFixedSpeed = document.querySelector("#ffixedSpeed");
const fieldTargetPressure = document.querySelector("#ftargetPressure");
const fieldMinSpeed = document.querySelector("#fminSpeed");
const fieldStepSize = document.querySelector("#fstepSize");
const fieldHoldTime = document.querySelector("#fholdTime");
// Setting fields radio buttons
//const fieldModes = document.querySelector("#fmode");
//const fieldDoorMode = document.querySelector("#fdoorMode");
//const fieldAlarmMode = document.querySelector("#falarmMode");
//const fieldCo2Mode = document.querySelector("#fco2Mode");

const connectingState = document.querySelector("#connectingState");

var selectDisplay;
var activeLinks;

function init()
{
    selectDisplay = "";
    activeLinks = "idleLinks";
}

settingForm.addEventListener("submit", (event) => 
{
  event.preventDefault();
  
  sendSettingData();
});

hepaFilterForm.addEventListener("submit", (event) =>
{
  event.preventDefault();
});

mainFilterForm.addEventListener("submit", (event) =>
{
  event.preventDefault();
});

commissionForm.addEventListener("submit", (event) => 
{
  event.preventDefault();
  
  sendCommissionData();
});

function menuHide()
{
    var x = document.getElementById(activeLinks);
    if (x)
    {
        x.style.display = "none";
    }
}

function toggleMenu()
{
    var x = document.getElementById(activeLinks);
    if (x.style.display === "block")
    {
        x.style.display = "none";
    }
    else
    {
        x.style.display = "block";
    }
}

function hideSelected()
{
    if (selectDisplay != "")
    {
        var x = document.getElementById(selectDisplay);

        if (x)
        {
            x.style.display = "none";
        }
    }
}

function showSelected()
{
    if (selectDisplay != "")
    {
        var x = document.getElementById(selectDisplay);

        if (x)
        {
            x.style.display = "block";
        }
    }
}

function showDiv(divName)
{
    hideSelected();

    selectDisplay = divName;

    showSelected();
    menuHide();
}

function handleModeClick(myRadio)
{
  if (myRadio.value == 0)
  {
    fieldFixedSpeed.disabled = false;
    fieldTargetPressure.disabled = true;
    fieldMinSpeed.disabled = true;
    fieldStepSize.disabled = true;
    fieldHoldTime.disabled = true;
  }
  else
  {
    fieldFixedSpeed.disabled = true;
    fieldTargetPressure.disabled = false;
    fieldMinSpeed.disabled = false;
    fieldStepSize.disabled = false;
    fieldHoldTime.disabled = false;  
  }
}

var BluetoothDataSources = [];
var BluetoothDevices = [];
var BluetoothCharacteristics = [];
var BluetoothConnected = false;
var TimeHasBeenSet = false;
var BluetoothSettingsRead = false;
var BluetoothCommissionRead = false;
var BluetoothStatusRead = 0;
var BluetoothFilterRead = 0;
var BluetoothGeneralRead = false;
var BluetoothDevice;



registerBluetoothDataSource(BluetoothDataSources, 0, "0666a01a-035e-4a01-9bd8-77b2b56a6bd1", "f31e779c-7729-4073-8319-a0a2f33524ed", blehandle_commission);
registerBluetoothDataSource(BluetoothDataSources, 1, "0666a01a-035e-4a01-9bd8-77b2b56a6bd1", "3bfa30cb-f9f9-4122-9367-979de74970b6", blehandle_settings);
registerBluetoothDataSource(BluetoothDataSources, 2, "0666a01a-035e-4a01-9bd8-77b2b56a6bd1", "d65a4ca2-5c9a-43ff-aac3-3091ba7e165b", blehandle_status);
registerBluetoothDataSource(BluetoothDataSources, 3, "0666a01a-035e-4a01-9bd8-77b2b56a6bd1", "469cbb22-dc08-4f1a-9e52-2626391ae161", blehandle_rtc);
registerBluetoothDataSource(BluetoothDataSources, 4, "0666a01b-035e-4a01-9bd8-77b2b56a6bd1", "59bb5014-1e25-4cdb-aab9-c675d7d5b608", blehandle_general);
registerBluetoothDataSource(BluetoothDataSources, 5, "0666a01b-035e-4a01-9bd8-77b2b56a6bd1", "f8885b19-317b-451c-bb17-ad16498fa694", blehandle_filter);


//Dont forget the RTC

function registerBluetoothDataSource(BluetoothDataSourcesArray, BluetoothIdx, BluetoothServiceUUID, BluetoothCharacteristicUUID, ValueHandler) 
{
  // Appends a data source, parser and target to the data sources list
  BluetoothDataSourcesArray.push({
    BluetoothIdx: BluetoothIdx,
    BluetoothServiceUUID: BluetoothServiceUUID,
    BluetoothCharacteristicUUID : BluetoothCharacteristicUUID,
    ValueHandler: ValueHandler});
};

function isWebBluetoothEnabled() 
{
    if (!navigator.bluetooth) 
    {
        menuHide();
        showDiv("connectingDiv");
        connectingState.innerHTML = "Web Bluetooth API is not available in this browser/device!";
        return false
    }
    return true
}

function onDisconnected(event)
{
  BluetoothConnected = false;
  menuHide();
  activeLinks = "idleLinks";
  showDiv("connectingDiv");
  connectingState.innerHTML = "Device disconnected";
  phdbgc = 0;
  phdbg.innerHTML = "";
}

function connect()
{
  if (isWebBluetoothEnabled())
  {
    BluetoothConnected = false;
    TimeHasBeenSet = false;
    BluetoothSettingsRead = false;
    BluetoothCommissionRead = false;
    BluetoothStatusRead = 0;
    BluetoothFilterRead = 0;
    BluetoothGeneralRead = false;
    
    menuHide();
    showDiv("connectingDiv");
    connectingState.innerHTML = "Connecting...";

    navigator.bluetooth.requestDevice({
       filters: [{name: 'CLEANCAB'}],
       optionalServices: ['0666a01a-035e-4a01-9bd8-77b2b56a6bd1', '0666a01b-035e-4a01-9bd8-77b2b56a6bd1']
     })
    .then(device => 
    {
      
      device.addEventListener('gattserverdisconnected', onDisconnected); 
      BluetoothDevice = device;
      
      BluetoothDataSources.forEach(source => 
      {
        connectBlueToothCharacteristic(device, 
          source.BluetoothIdx, 
          source.BluetoothServiceUUID.toLowerCase(), 
          source.BluetoothCharacteristicUUID.toLowerCase(), 
          source.ValueHandler); 
      });
      setTimeout(BluetoothPoll, 1000);
      activeLinks = "connectedLinks";
      connectingState.innerHTML = "Connected";
      BluetoothConnected = true;
    })
    .catch(error => 
    {
      connectingState.innerHTML = "Connection Failed: " + error;
    });
  }
}

function disconnect()
{
    menuHide();
    activeLinks = "idleLinks";
    showDiv("connectingDiv");
    connectingState.innerHTML = "Disconnected";
    if (BluetoothConnected)
    {
        BluetoothDevice.gatt.disconnect();
    }
    phdbgc = 0;
    phdbg.innerHTML = "";
    BluetoothConnected = false;    
}

function connectBlueToothCharacteristic(BluetoothDevice, BluetoothIdx, BluetoothServiceUUID, BluetoothCharacteristicUUID, ValueHandler)
{
  BluetoothDevice.gatt.connect()
      .then(server => 
        {
            return server.getPrimaryService(BluetoothServiceUUID);
        })
      .then(service => 
        {
            return service.getCharacteristic(BluetoothCharacteristicUUID);
        })
      .then(characteristic => 
        {
            BluetoothCharacteristics[BluetoothIdx] = characteristic;
            
            characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', function(event){ ValueHandler(event, BluetoothIdx) });
            //return characteristic.readValue();
        })
      .catch(error => 
      {
         connectingState.innerHTML = error;
      });
};

var BluetoothReadWait = 0;

function BluetoothPoll()
{
  if (BluetoothConnected)
  {
    phdbgc++;
    phdbg.innerHTML = phdbgc;
    
    if (connectingState.innerHTML === "Connecting...")
    {
        connectingState.innerHTML="Connected";
    }
    if (BluetoothReadWait > 0)
    {
      BluetoothReadWait--;
    }
    if (BluetoothReadWait <= 0)
    {
        if (!TimeHasBeenSet)
        {
          if (BluetoothCharacteristics[3])
          {
            TimeHasBeenSet = true;
            BluetoothReadWait = 2;
          
            const date = new Date();
        
            let data = new Uint8Array(7);
            data[0] = date.getDate();
            data[1] = date.getMonth() + 1;
            data[2] = date.getFullYear() & 0x00ff;
            data[3] = (date.getFullYear() >> 8) & 0x00ff;
            data[4] = date.getHours();
            data[5] = date.getMinutes();
            data[6] = date.getSeconds();
            BluetoothCharacteristics[3].writeValue(data); 

            connectingState.innerHTML += "<br>Setting RTC";          
          }
          BluetoothReadWait = 4;
        }
        else
        {
          if (!BluetoothCommissionRead &&                                           //commission
              BluetoothCharacteristics[0])
          {
            connectingState.innerHTML += "<br>Fetching Commission Data";   
            BluetoothReadWait = 4;
            BluetoothCharacteristics[0].readValue(); 
          }
          else if (!BluetoothSettingsRead &&                                        //settings
              BluetoothCharacteristics[1])
          {
            connectingState.innerHTML += "<br>Fetching Setting Data";   
            BluetoothReadWait = 4;
            BluetoothCharacteristics[1].readValue();         
          }
          else if (!BluetoothGeneralRead &&                                         //general
            BluetoothCharacteristics[4])    
          {
            connectingState.innerHTML += "<br>Fetching Device Details";   
            BluetoothReadWait = 4;
            BluetoothCharacteristics[4].readValue();         
          }
          else if (BluetoothFilterRead == 0 &&
            BluetoothCharacteristics[5])
          {
            BluetoothReadWait = 2;
            let data = new Uint8Array(2);
            data[0] = 1;
            data[1] = 1;
            BluetoothFilterRead = 1;
            BluetoothCharacteristics[5].writeValue(data); 
          }
          else if (BluetoothFilterRead == 1 &&
            BluetoothCharacteristics[5])
          {
            connectingState.innerHTML += "<br>Fetching Hepa Filter Details";   
            BluetoothReadWait = 4;
            BluetoothCharacteristics[5].readValue(); 
          }
          else if (BluetoothFilterRead == 2 &&
            BluetoothCharacteristics[5])
          {
            BluetoothReadWait = 2;
            let data = new Uint8Array(2);
            data[0] = 2;
            data[1] = 2;
            BluetoothFilterRead = 3;
            BluetoothCharacteristics[5].writeValue(data); 
          }
          else if (BluetoothFilterRead == 3 &&
            BluetoothCharacteristics[5])
          {
            connectingState.innerHTML += "<br>Fetching Main Filter Details";   
            BluetoothReadWait = 4;
            BluetoothCharacteristics[5].readValue(); 
          }
          else if (BluetoothStatusRead != 1 &&                                          //status
              BluetoothCharacteristics[2])
          {
            if (BluetoothStatusRead == 0)
            {
              connectingState.innerHTML += "<br>Fetching Status Data";   
            }
            BluetoothReadWait = 5;
            BluetoothCharacteristics[2].readValue();         
          }        
        }
        if (selectDisplay === "connectingDiv")
        {
          if (TimeHasBeenSet &&
              BluetoothCommissionRead &&
              BluetoothSettingsRead &&
              BluetoothStatusRead == 1 &&
              BluetoothFilterRead == 4 &&
              BluetoothGeneralRead)      
          {
            showDiv("statusDiv");
          }
        }
    }
 
    if (BluetoothReadWait <= 0)
    {
      if (selectDisplay === "statusDiv")
      {
        BluetoothStatusRead = 2; 
      }
    }
    setTimeout(BluetoothPoll, 200);
  }
}

function setRadioInput(fieldName, selectValue)
{
  var radios = document.getElementsByName(fieldName);
  for (var j = 0; j < radios.length; j++) 
  {
    if (radios[j].value == selectValue) 
    {
      radios[j].checked = true;
      break;
    }
  }
}

function getRadioInput(fieldName)
{
  var radios = document.getElementsByName(fieldName);
  for (var j = 0; j < radios.length; j++) 
  {
    if (radios[j].checked) 
    {
      return radios[j].value;
    }
  }
  return 0;
}

var homeCounter = 0;

function getNowDateForInput()
{        
  const date = new Date();
        
  thedate = date.getFullYear() + "-";
        
  let realMonth = date.getMonth() + 1;
  if (realMonth < 10)
  {
    thedate += '0';
  }
  thedate += realMonth + '-';
  if (date.getDate() < 10)
  {
    thedate += '0';
  }
  thedate += date.getDate();
  
  return thedate;
}
     
const cInstalledDate = document.querySelector("#cInstalledDate");
const cInstallerCompany = document.querySelector("#cInstallerCompany");
const cInstallerName = document.querySelector("#cInstallerName");
const cInstallerPhone = document.querySelector("#cInstallerPhone");
const cMachineName = document.querySelector("#cMachineName");
const cPlantNumber = document.querySelector("#cPlantNumber");
const cSaveRow = document.querySelector("#cSaveRow");
const phdbg1 = document.querySelector("#phdbg1");

function blehandle_commission(event, bluetoothId)
{
  if (!BluetoothCommissionRead)
  {
    BluetoothCommissionRead = true;
    BluetoothReadWait = 0;

    const decodedValue = new TextDecoder().decode(event.target.value);

    const myArray = decodedValue.split("|");
    
    let entryDisabled = false;
    
    cSaveRow.style.display = "none";
    if (myArray.length >= 7)
    {
      cInstalledDate.value = myArray[1];
      cInstallerName.value = myArray[2];
      cInstallerPhone.value = myArray[3];
      cInstallerCompany.value = myArray[4];
      cMachineName.value = myArray[5];
      cPlantNumber.value = myArray[6];

      entryDisabled = (myArray[0] === "V");    
    }
    if (!entryDisabled)
    {
        cInstalledDate.value = getNowDateForInput();
    }
    if (homeCounter > 3)
    {
      entryDisabled = false;
    }
    cSaveRow.style.display = (entryDisabled) ? "none" : "block";
    //cInstalledDate.readOnly = entryDisabled;
    cInstallerName.readOnly = entryDisabled;
    cInstallerPhone.readOnly = entryDisabled;
    cInstallerCompany.readOnly = entryDisabled;
    cMachineName.readOnly = entryDisabled;
    cPlantNumber.readOnly = entryDisabled;
  }
}

function sendCommissionData()
{
  cdata = cInstalledDate.value + "|" +
          cInstallerName.value + "|" +
          cInstallerPhone.value + "|" +
          cInstallerCompany.value + "|" +
          cMachineName.value + "|" +
          cPlantNumber.value;

  BluetoothReadWait = 4;
  
  const encodedValue = new TextEncoder().encode(cdata);

  BluetoothCharacteristics[0].writeValue(encodedValue); 
  
  BluetoothCommissionRead = false;
}


function blehandle_settings(event, bluetoothId)
{
  if (!BluetoothSettingsRead)
  {
    BluetoothSettingsRead = true;
    BluetoothReadWait = 0;
    
    var mode = event.target.value.getUint16(0, true);
    setRadioInput("fmode", event.target.value.getUint16(0, true));
    fieldRampRate.value = event.target.value.getUint16(2, true);
    fieldFixedSpeed.value = event.target.value.getUint16(4, true);
    fieldDoorSpeed.value = event.target.value.getUint16(6, true);
    fieldMinSpeed.value = event.target.value.getUint16(8, true);
    fieldTargetPressure.value = event.target.value.getUint16(10, true);
    fieldStepSize.value = event.target.value.getUint16(12, true);
    fieldHoldTime.value = event.target.value.getUint16(14, true);
    fieldStartPause.value = event.target.value.getUint16(16, true);
    setRadioInput("fdoorMode", event.target.value.getUint16(18, true));
    setRadioInput("falarmMode", event.target.value.getUint16(20, true));
    setRadioInput("fco2Mode", event.target.value.getUint16(22, true));
    
    fieldFixedSpeed.disabled = mode == 1;
    fieldTargetPressure.disabled = mode == 0;
    fieldMinSpeed.disabled = mode == 0;
    fieldStepSize.disabled = mode == 0;
    fieldHoldTime.disabled = mode == 0;
  }  
}

function sendSettingData()
{
  const buffer = new ArrayBuffer(24);
  const view = new DataView(buffer);

  BluetoothReadWait = 4;
  view.setUint16( 0, getRadioInput("fmode"), true);
  view.setUint16( 2, fieldRampRate.value, true);
  view.setUint16( 4, fieldFixedSpeed.value, true);
  view.setUint16( 6, fieldDoorSpeed.value, true);
  view.setUint16( 8, fieldMinSpeed.value, true);
  view.setUint16(10, fieldTargetPressure.value, true);
  view.setUint16(12, fieldStepSize.value, true);
  view.setUint16(14, fieldHoldTime.value, true);
  view.setUint16(16, fieldStartPause.value, true);
  view.setUint16(18, getRadioInput("fdoorMode"), true);
  view.setUint16(20, getRadioInput("falarmMode"), true);
  view.setUint16(22, getRadioInput("fco2Mode"), true);
  
  BluetoothCharacteristics[1].writeValue(buffer); 
  
  BluetoothSettingsRead = false;
}

const sFanSpeedBar = document.querySelector("#sFanSpeedBar");
const sPressureBar = document.querySelector("#sPressureBar");
const sDoorState = document.querySelector("#sDoorState");
const sAlarmState = document.querySelector("#sAlarmState");
const sCO2State = document.querySelector("#sCO2State");
const sMotorTime = document.querySelector("#sMotorTime");
const sHepaFilterTime = document.querySelector("#sHepaFilterTime");
const sMainFilterTime = document.querySelector("#sMainFilterTime");

function blehandle_status(event, bluetoothId)
{
  BluetoothStatusRead = 1;
  //BluetoothReadWait = 0; always let the timeout expire
  
  fan = (((event.target.value.getUint8(0) * 100) + 0.5) / 255 >> 0);
  if (fan > 100)
  {
    fan = 100;
  }
  sFanSpeedBar.style.width = fan + '%';
  sFanSpeedBar.innerHTML = fan + '%';

  if (event.target.value.getUint8(1) == 3)
  {
    sDoorState.value = "Disabled";
  } 
  else if (event.target.value.getUint8(1) == 0)  
  {
    sDoorState.value = "Closed";
  }
  else
  {
    sDoorState.value = "Opened";
  }

  if (event.target.value.getUint8(2) == 3)
  {
    sAlarmState.value = "Disabled";
  } 
  else if (event.target.value.getUint8(2) == 0)  
  {
    sAlarmState.value = "Inactive";
  }
  else
  {
    sAlarmState.value = "Alarmed";
  }

  if (event.target.value.getUint8(3) == 3)
  {
    sCO2State.value = "Disabled";
  } 
  else if (event.target.value.getUint8(3) == 0)  
  {
    sCO2State.value = "Inactive";
  }
  else
  {
    sCO2State.value = "Alarmed";
  }
  
  //NOTE: With the pressure. need to scale to 100% (ie choose a range and if greater the set to 100)

  pressure = (event.target.value.getUint16(4, true) / 2 >> 0);
  if (pressure > 100)
  {
    pressure = 100;
  }
  
  sPressureBar.style.width = pressure + '%';
  sPressureBar.innerHTML = event.target.value.getUint16(4, true) + 'pa';
  sHepaFilterTime.value = event.target.value.getUint32(6, true)
  sMainFilterTime.value = event.target.value.getUint32(10, true)
  sMotorTime.value = event.target.value.getUint32(14, true)
}

function blehandle_rtc(event, bluetoothId)
{
}

function home()
{
  homeCounter++;
  
  phdbg1.innerHTML = homeCounter;
  if (homeCounter > 3)
  {
    BluetoothCommissionRead = true;
  }
}

function blehandle_general(event, bluetoothId)
{
  if (!BluetoothGeneralRead)
  {
    BluetoothGeneralRead = true;
    BluetoothReadWait = 0;
    const decodedValue = new TextDecoder().decode(event.target.value);
    
    connectingState.innerHTML += "<br>Version: " + decodedValue;  
  }    
}

const hepaInstalledDate = document.querySelector("#hepaInstalledDate");
const hepaPartNumber = document.querySelector("#hepaPartNumber");
const hepaInstallerName = document.querySelector("#hepaInstallerName");
const hepaInstallerId = document.querySelector("#hepaInstallerId");

const mainInstalledDate = document.querySelector("#mainInstalledDate");
const mainPartNumber = document.querySelector("#mainPartNumber");
const mainInstallerName = document.querySelector("#mainInstallerName");
const mainInstallerId = document.querySelector("#mainInstallerId");

function filterDataValid(data)
{
    return data.getUint8(1) > 0;
}   

function filterDataDate(data)
{
    thedate = "20";
    if (data.getUint8(4) < 10)
    {
      thedate += "0";
    }
    thedate += data.getUint8(4) + "-";
    if (data.getUint8(3) < 10)
    {
      thedate += "0";
    }
    thedate += data.getUint8(3) + "-";
    if (data.getUint8(2) < 10)
    {
      thedate += "0";
    }
    thedate += data.getUint8(2);
    
    return thedate;
}

function filterDataStrings(data)
{        
  thelen = data.getUint8(11);
        
  const view2 = new DataView(data.buffer, 12, thelen);
  const decodedValue = new TextDecoder().decode(view2);
  return decodedValue.split("|");
}    
   

function blehandle_filter(event, bluetoothId)
{
    var eventId = event.target.value.getUint8(0);
    
    if (eventId == 1 && BluetoothFilterRead == 1)
    {
      BluetoothFilterRead = 2;
      BluetoothReadWait = 0

      if (filterDataValid(event.target.value))
      {
        hepaInstalledDate.value = filterDataDate(event.target.value);
        const filterStrings = filterDataStrings(event.target.value);
        if (filterStrings.length >= 3)
        {
            hepaPartNumber.value = filterStrings[0];
            hepaInstallerName.value = filterStrings[1];
            hepaInstallerId.value = filterStrings[2];
        }
      }
    }
    else if (eventId == 2 && BluetoothFilterRead == 3)
    {
      BluetoothFilterRead = 4;
      BluetoothReadWait = 0;

      if (filterDataValid(event.target.value))
      {
        mainInstalledDate.value = filterDataDate(event.target.value);
        const filterStrings = filterDataStrings(event.target.value);
        if (filterStrings.length >= 3)
        {
            mainPartNumber.value = filterStrings[0];
            mainInstallerName.value = filterStrings[1];
            mainInstallerId.value = filterStrings[2];
        }
      }
    }
}

addingFilter = 0;
addHepaBtn = document.querySelector("#addHepaBtn");
addMainBtn = document.querySelector("#addMainBtn");
filterForm = document.querySelector("#filterForm");
addHepaDiv = document.querySelector("#addHepaDiv");
addMainDiv = document.querySelector("#addMainDiv");

filterPartNumber = document.querySelector("#filterPartNumber");
filterInstallerName = document.querySelector("#filterInstallerName");
filterInstallerId = document.querySelector("#filterInstallerId");

function replaceFilter(filterType)
{
  if (addingFilter == filterType)
  {
    // hide the form
    
    addHepaBtn.value = "Replace";
    addMainBtn.value = "Replace";
    addingFilter = 0;
    filterForm.style.display="none";
  }
  else if (addingFilter == 0)
  {
    addingFilter = filterType;
    if (filterType == 1)
        addHepaBtn.value = "Cancel Replace";
    if (filterType == 2)
        addMainBtn.value = "Cancel Replace";
    filterForm.style.display="block";
  }
  addMainBtn.disabled = addingFilter == 1;
  addHepaBtn.disabled = addingFilter == 2;
  addHepaDiv.style.display = (addingFilter != 2) ? "block" : "none"
  addMainDiv.style.display = (addingFilter != 1) ? "block" : "none"
}

function filterSave()
{
    if (addingFilter != 0)
    {
        cdata = filterPartNumber.value + "|" + filterInstallerName.value + "|" + filterInstallerId.value;

        BluetoothReadWait = 4;
  
        const encodedValue = new TextEncoder().encode(cdata);

        const sdata = new Uint8Array(3 + encodedValue.length);
        
        sdata[0] = 3;
        sdata[1] = 5;
        sdata[2] = addingFilter - 1;
        sdata.set(encodedValue, 3);
        BluetoothCharacteristics[5].writeValue(sdata); 
  
        if (addingFilter == 1)
        {
            hepaInstalledDate.value = getNowDateForInput();
            hepaPartNumber.value = filterPartNumber.value;
            hepaInstallerName.value = filterInstallerName.value;
            hepaInstallerId.value = filterInstallerId.value;
        }
        else
        {
            mainInstalledDate.value = getNowDateForInput();
            mainPartNumber.value = filterPartNumber.value;
            mainInstallerName.value = filterInstallerName.value;
            mainInstallerId.value = filterInstallerId.value;
        }
        replaceFilter(addingFilter);    
        filterPartNumber.value = "";  
        filterInstallerName.value = "";
        filterInstallerId.value = "";                
    }
}

</script>

</body>
</html>
